================================================================================
                        OMICVERSE AGENT WORKFLOW
                    Complete System Architecture (ASCII)
================================================================================


    +===========================================================================+
    |                                                                           |
    |    USER INPUT                                                             |
    |    +-----------------------------------------------------------------+    |
    |    |  "quality control with nUMI>500, mito<0.2"  +  AnnData object   |    |
    |    +-----------------------------------------------------------------+    |
    |                                      |                                    |
    +======================================|====================================+
                                           |
                                           v
    +===========================================================================+
    |                                                                           |
    |    OMICVERSE AGENT (smart_agent.py)                                       |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |  Configuration:                                                  |   |
    |    |  +------------------------------------------------------------+ |   |
    |    |  | model="gemini-2.5-flash" | enable_reflection=True          | |   |
    |    |  | api_key=None             | reflection_iterations=1-3       | |   |
    |    |  | endpoint=None            | enable_result_review=True       | |   |
    |    |  | max_prompts_per_session=5| use_notebook_execution=True     | |   |
    |    |  +------------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                      |                                    |
    +======================================|====================================+
                                           |
                                           v
    +===========================================================================+
    |                                                                           |
    |    DIRECT PYTHON DETECTION                                                |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |     Request contains ```python ... ``` block?                   |   |
    |    |                                                                  |   |
    |    |          YES -----> Execute directly (skip LLM)                 |   |
    |    |           |                                                     |   |
    |    |          NO                                                     |   |
    |    |           |                                                     |   |
    |    |           v                                                     |   |
    |    |     Continue to Complexity Analysis                             |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                      |                                    |
    +======================================|====================================+
                                           |
                                           v
    +===========================================================================+
    |                                                                           |
    |    TASK COMPLEXITY ANALYSIS (_analyze_task_complexity)                    |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    LLM evaluates request:                                       |   |
    |    |    - Keywords analysis                                          |   |
    |    |    - Multi-step detection                                       |   |
    |    |    - Workflow indicators                                        |   |
    |    |                                                                  |   |
    |    |         +----------+              +----------+                  |   |
    |    |         |  SIMPLE  |              | COMPLEX  |                  |   |
    |    |         +----+-----+              +----+-----+                  |   |
    |    |              |                         |                        |   |
    |    +--------------|-------------------------|------------------------+   |
    |                   |                         |                             |
    +==================|=========================|=============================+
                       |                         |
                       v                         v
    +===========================================+===============================+
    |                                           |                               |
    |  PRIORITY 1: REGISTRY WORKFLOW            |  PRIORITY 2: SKILLS WORKFLOW  |
    |  (Fast - 60-70% faster)                   |  (Comprehensive)              |
    |                                           |                               |
    +=========================================+=+===============================+
                       |                         |
                       v                         v
+----------------------+-----------------------+ +------------------------------+
|                                              | |                              |
|  +----------------------------------------+  | |  +------------------------+  |
|  |                                        |  | |  |                        |  |
|  |   FUNCTION REGISTRY ONLY               |  | |  |   SKILL MATCHING       |  |
|  |   (registry.py)                        |  | |  |   (skill_registry.py)  |  |
|  |                                        |  | |  |                        |  |
|  |   +--------------------------------+   |  | |  |  LLM selects skills:   |  |
|  |   |  100+ OmicVerse functions      |   |  | |  |  - bulk-deg-analysis   |  |
|  |   |  - Preprocessing (qc, filter)  |   |  | |  |  - single-clustering   |  |
|  |   |  - Normalization (scale, log)  |   |  | |  |  - gsea-enrichment     |  |
|  |   |  - Analysis (pca, clustering)  |   |  | |  |  - spatial-tutorials   |  |
|  |   |  - Visualization (umap, plot)  |   |  | |  |  - ... (25 skills)     |  |
|  |   +--------------------------------+   |  | |  |                        |  |
|  |                                        |  | |  +------------------------+  |
|  |   Single prompt to LLM:                |  | |                              |
|  |   - Registry functions info            |  | |  Lazy loading:               |
|  |   - Generate 1-3 function calls        |  | |  - Metadata at startup       |
|  |   - No complex workflows               |  | |  - Full content on-demand    |
|  |                                        |  | |                              |
|  +----------------------------------------+  | +------------------------------+
|                                              |                |
|  If "NEEDS_WORKFLOW" returned:               |                v
|  +----------------------------------------+  | +------------------------------+
|  |                                        |  | |                              |
|  |   FALLBACK to Priority 2 ------------------>|  SKILL + REGISTRY PROMPT     |
|  |                                        |  | |                              |
|  +----------------------------------------+  | |  +------------------------+  |
|                                              | |  |  - Registry functions  |  |
+----------------------------------------------+ |  |  - Skill guidance      |  |
                       |                         |  |  - Multi-step support  |  |
                       |                         |  |  - Complex logic OK    |  |
                       |                         |  +------------------------+  |
                       |                         |                              |
                       |                         +------------------------------+
                       |                                        |
                       +------------------------+---------------+
                                                |
                                                v
    +===========================================================================+
    |                                                                           |
    |    LLM BACKEND (agent_backend.py)                                         |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    +-----------+  +-----------+  +-----------+  +-----------+   |   |
    |    |    |  OpenAI   |  | Anthropic |  |  Google   |  | DeepSeek  |   |   |
    |    |    | GPT-4/5/o1|  |Claude 3.5 |  |Gemini 2.5 |  |  Qwen     |   |   |
    |    |    +-----------+  +-----------+  +-----------+  +-----------+   |   |
    |    |                                                                  |   |
    |    |    Features:                                                     |   |
    |    |    - Provider-agnostic async/sync interface                     |   |
    |    |    - Built-in retry with exponential backoff                    |   |
    |    |    - Token usage tracking                                       |   |
    |    |    - Streaming support                                          |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                      |                                    |
    +======================================|====================================+
                                           |
                                           v
    +===========================================================================+
    |                                                                           |
    |    CODE GENERATION & EXTRACTION                                           |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    LLM Response:                                                 |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |  ```python                                               | |   |
    |    |    |  import omicverse as ov                                  | |   |
    |    |    |  import scanpy as sc                                     | |   |
    |    |    |                                                          | |   |
    |    |    |  # Quality control                                       | |   |
    |    |    |  ov.pp.qc(adata, tresh={                                 | |   |
    |    |    |      'nUMIs': 500,                                       | |   |
    |    |    |      'mito_perc': 0.2,                                   | |   |
    |    |    |      'detected_genes': 250                               | |   |
    |    |    |  })                                                      | |   |
    |    |    |  ```                                                     | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    |    _extract_python_code() -> Python string                      |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                      |                                    |
    +======================================|====================================+
                                           |
                                           v
    +===========================================================================+
    |                                                                           |
    |    CODE TRANSFORMATION (ProactiveCodeTransformer)                         |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    Automatic fixes:                                             |   |
    |    |                                                                  |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |                                                          | |   |
    |    |    |  1. In-place function assignments:                       | |   |
    |    |    |     adata = ov.pp.pca(adata)  -->  ov.pp.pca(adata)     | |   |
    |    |    |                                                          | |   |
    |    |    |  2. F-string conversion in prints:                       | |   |
    |    |    |     print(f"Result: {v}")  -->  print("Result: "+str(v))| |   |
    |    |    |                                                          | |   |
    |    |    |  3. .cat accessor guards:                                | |   |
    |    |    |     .cat.categories  -->  .value_counts().index.tolist()| |   |
    |    |    |                                                          | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                      |                                    |
    +======================================|====================================+
                                           |
                              +------------+------------+
                              |                         |
                              v                         |
    +===========================================================================+
    |                                                                           |
    |    REFLECTION LOOP (Optional, 1-3 iterations)                             |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    _reflect_on_code():                                          |   |
    |    |                                                                  |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |                                                          | |   |
    |    |    |   LLM reviews code for:                                  | |   |
    |    |    |   [x] Syntax errors / typos                              | |   |
    |    |    |   [x] Missing imports                                    | |   |
    |    |    |   [x] In-place function issues                           | |   |
    |    |    |   [x] .cat accessor problems                             | |   |
    |    |    |   [x] Parameter correctness                              | |   |
    |    |    |   [x] Logic flow                                         | |   |
    |    |    |                                                          | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    |    Returns:                                                     |   |
    |    |    - issues_found: List[str]                                    |   |
    |    |    - needs_revision: bool                                       |   |
    |    |    - improved_code: str                                         |   |
    |    |    - confidence: float (0-1)                                    |   |
    |    |                                                                  |   |
    |    |         needs_revision = True?                                  |   |
    |    |              |        |                                         |   |
    |    |             YES       NO                                        |   |
    |    |              |        |                                         |   |
    |    |              v        +---> Continue to Execution               |   |
    |    |         Loop back (max iterations)                              |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                      |                                    |
    +======================================|====================================+
                                           |
                                           v
    +===========================================================================+
    |                                                                           |
    |    CODE EXECUTION                                                         |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    Two execution strategies:                                    |   |
    |    |                                                                  |   |
    |    |    +------------------------+    +----------------------------+ |   |
    |    |    |                        |    |                            | |   |
    |    |    |  NOTEBOOK EXECUTION    |    |  IN-PROCESS EXECUTION      | |   |
    |    |    |  (session_notebook_    |    |  (fallback)                | |   |
    |    |    |   executor.py)         |    |                            | |   |
    |    |    |                        |    |                            | |   |
    |    |    |  - Isolated Jupyter    |    |  - compile() + exec()      | |   |
    |    |    |    kernel session      |    |  - Sandbox locals:         | |   |
    |    |    |  - Persistent state    |    |    {adata, ov, sc, ...}   | |   |
    |    |    |  - Max N prompts per   |    |  - Direct execution        | |   |
    |    |    |    session             |    |  - Lighter weight          | |   |
    |    |    |  - Auto kernel restart |    |                            | |   |
    |    |    |                        |    |                            | |   |
    |    |    +------------------------+    +----------------------------+ |   |
    |    |                                                                  |   |
    |    |    ~/.ovagent/sessions/                                         |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                      |                                    |
    +======================================|====================================+
                                           |
                                           v
    +===========================================================================+
    |                                                                           |
    |    RESULT REVIEW (Optional)                                               |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    _review_result():                                            |   |
    |    |                                                                  |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |                                                          | |   |
    |    |    |   Comparison:                                            | |   |
    |    |    |   - Original adata shape vs Result adata shape           | |   |
    |    |    |   - Expected changes vs Actual changes                   | |   |
    |    |    |   - Intent matching assessment                           | |   |
    |    |    |                                                          | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    |    Returns:                                                     |   |
    |    |    - matched: bool                                              |   |
    |    |    - confidence: float (0-1)                                    |   |
    |    |    - explanation: str                                           |   |
    |    |    - changes_detected: bool                                     |   |
    |    |                                                                  |   |
    |    |    Output:                                                      |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |  "Result matches intent (confidence: 95%)"               | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                      |                                    |
    +======================================|====================================+
                                           |
                                           v
    +===========================================================================+
    |                                                                           |
    |    OUTPUT                                                                 |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    Modified AnnData object returned to user                     |   |
    |    |                                                                  |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |                                                          | |   |
    |    |    |   adata                                                  | |   |
    |    |    |   - n_obs x n_vars (filtered cells x genes)              | |   |
    |    |    |   - .obs: cell annotations                               | |   |
    |    |    |   - .var: gene annotations                               | |   |
    |    |    |   - .obsm: embeddings (X_pca, X_umap, etc.)              | |   |
    |    |    |   - .layers: transformed data                            | |   |
    |    |    |                                                          | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    |    Token usage breakdown:                                       |   |
    |    |    - generation: {...}                                          |   |
    |    |    - reflection: [{...}, ...]                                   |   |
    |    |    - review: [{...}, ...]                                       |   |
    |    |    - total: {...}                                               |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                                                           |
    +===========================================================================+


================================================================================
                         SUPPORTING SYSTEMS
================================================================================


    +===========================================================================+
    |                                                                           |
    |    FILESYSTEM CONTEXT MANAGER (filesystem_context.py)                     |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    Location: ~/.ovagent/context/<session_id>/                   |   |
    |    |                                                                  |   |
    |    |    Operations:                                                  |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |                                                          | |   |
    |    |    |   write_note(key, content, category, metadata)           | |   |
    |    |    |   --> Save intermediate results with metadata            | |   |
    |    |    |                                                          | |   |
    |    |    |   retrieve_context(pattern, type="glob|grep")            | |   |
    |    |    |   --> Search for relevant context files                  | |   |
    |    |    |                                                          | |   |
    |    |    |   save_plan(steps: List[str])                            | |   |
    |    |    |   --> Track multi-step execution plan                    | |   |
    |    |    |                                                          | |   |
    |    |    |   mark_step_complete(step_index, result)                 | |   |
    |    |    |   --> Update plan progress                               | |   |
    |    |    |                                                          | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    |    Context tokens in generated code:                            |   |
    |    |    - CONTEXT_WRITE: qc_result -> {data}                         |   |
    |    |    - CONTEXT_PLAN: Step 1 [pending], Step 2 [pending]           |   |
    |    |    - CONTEXT_UPDATE: step=0, status=completed                   |   |
    |    |    - CONTEXT_SEARCH: pattern="qc*", type="glob"                 |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                                                           |
    +===========================================================================+


    +===========================================================================+
    |                                                                           |
    |    SKILL REGISTRY (skill_registry.py)                                     |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    Skill Locations:                                             |   |
    |    |    - /omicverse/.claude/skills/      (25 built-in)              |   |
    |    |    - <project>/.claude/skills/       (user-defined)             |   |
    |    |                                                                  |   |
    |    |    Skill Format (YAML + Markdown):                              |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |  ---                                                     | |   |
    |    |    |  name: single-clustering                                 | |   |
    |    |    |  description: Guide through clustering workflow          | |   |
    |    |    |  ---                                                     | |   |
    |    |    |                                                          | |   |
    |    |    |  # Single-cell Clustering                                | |   |
    |    |    |                                                          | |   |
    |    |    |  ## Steps:                                               | |   |
    |    |    |  1. Preprocessing with ov.pp.qc()                        | |   |
    |    |    |  2. Normalize with ov.pp.scale()                         | |   |
    |    |    |  3. Find HVGs with ov.pp.highly_variable_genes()         | |   |
    |    |    |  4. PCA with ov.pp.pca()                                 | |   |
    |    |    |  5. Neighbors with ov.pp.neighbors()                     | |   |
    |    |    |  6. Clustering with ov.pp.leiden()                       | |   |
    |    |    |  ...                                                     | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    |    Built-in Skills (25 total):                                  |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |                                                          | |   |
    |    |    |   BULK RNA-SEQ:                                          | |   |
    |    |    |   - bulk-deg-analysis                                    | |   |
    |    |    |   - bulk-deseq2-analysis                                 | |   |
    |    |    |   - bulk-wgcna-analysis                                  | |   |
    |    |    |   - bulk-combat-correction                               | |   |
    |    |    |   - bulk-to-single-deconvolution                         | |   |
    |    |    |   - bulk-stringdb-ppi                                    | |   |
    |    |    |   - bulk-trajblend-interpolation                         | |   |
    |    |    |                                                          | |   |
    |    |    |   SINGLE-CELL:                                           | |   |
    |    |    |   - single-preprocessing                                 | |   |
    |    |    |   - single-clustering                                    | |   |
    |    |    |   - single-annotation                                    | |   |
    |    |    |   - single-trajectory                                    | |   |
    |    |    |   - single-cellphone-db                                  | |   |
    |    |    |   - single-multiomics                                    | |   |
    |    |    |   - single-downstream-analysis                           | |   |
    |    |    |   - single-to-spatial-mapping                            | |   |
    |    |    |                                                          | |   |
    |    |    |   SPATIAL:                                               | |   |
    |    |    |   - spatial-tutorials                                    | |   |
    |    |    |                                                          | |   |
    |    |    |   VISUALIZATION & EXPORT:                                | |   |
    |    |    |   - plotting-visualization                               | |   |
    |    |    |   - data-viz-plots                                       | |   |
    |    |    |   - data-export-pdf                                      | |   |
    |    |    |   - data-export-excel                                    | |   |
    |    |    |                                                          | |   |
    |    |    |   ANALYSIS:                                              | |   |
    |    |    |   - gsea-enrichment                                      | |   |
    |    |    |   - data-stats-analysis                                  | |   |
    |    |    |   - data-transform                                       | |   |
    |    |    |   - tcga-preprocessing                                   | |   |
    |    |    |                                                          | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                                                           |
    +===========================================================================+


    +===========================================================================+
    |                                                                           |
    |    FUNCTION REGISTRY (registry.py)                                        |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    100+ registered functions across categories:                 |   |
    |    |                                                                  |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |                                                          | |   |
    |    |    |   PREPROCESSING (ov.pp.*)                                | |   |
    |    |    |   - qc, filter_cells, filter_genes                       | |   |
    |    |    |   - normalize, log1p, scale                              | |   |
    |    |    |   - highly_variable_genes                                | |   |
    |    |    |   - pca, neighbors                                       | |   |
    |    |    |                                                          | |   |
    |    |    |   TOOLS (ov.tl.* / ov.pl.*)                              | |   |
    |    |    |   - leiden, louvain                                      | |   |
    |    |    |   - umap, tsne                                           | |   |
    |    |    |   - rank_genes_groups                                    | |   |
    |    |    |   - dpt, paga                                            | |   |
    |    |    |                                                          | |   |
    |    |    |   PLOTTING (ov.pl.*)                                     | |   |
    |    |    |   - embedding, violin, dotplot                           | |   |
    |    |    |   - heatmap, volcano, scatter                            | |   |
    |    |    |                                                          | |   |
    |    |    |   BULK (ov.bulk.*)                                       | |   |
    |    |    |   - deg_analysis, pydeseq2                               | |   |
    |    |    |   - combat, wgcna                                        | |   |
    |    |    |                                                          | |   |
    |    |    |   SPATIAL (ov.space.*)                                   | |   |
    |    |    |   - deconvolution, mapping                               | |   |
    |    |    |                                                          | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    |    Registration via decorator:                                  |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |    |                                                          | |   |
    |    |    |   @register_function(                                    | |   |
    |    |    |       name="qc",                                         | |   |
    |    |    |       aliases=["quality_control", "QC"],                 | |   |
    |    |    |       category="preprocessing",                          | |   |
    |    |    |       prerequisites=[],                                  | |   |
    |    |    |       produces=["qc_metrics"],                           | |   |
    |    |    |       example="ov.pp.qc(adata, tresh={...})"             | |   |
    |    |    |   )                                                      | |   |
    |    |    |   def qc(adata, tresh=None, ...):                        | |   |
    |    |    |       ...                                                | |   |
    |    |    |                                                          | |   |
    |    |    +----------------------------------------------------------+ |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                                                           |
    +===========================================================================+


    +===========================================================================+
    |                                                                           |
    |    TOKEN USAGE TRACKING                                                   |
    |    +------------------------------------------------------------------+   |
    |    |                                                                  |   |
    |    |    @dataclass                                                   |   |
    |    |    class Usage:                                                 |   |
    |    |        input_tokens: int                                        |   |
    |    |        output_tokens: int                                       |   |
    |    |        total_tokens: int                                        |   |
    |    |        model: str                                               |   |
    |    |        provider: str                                            |   |
    |    |                                                                  |   |
    |    |    agent.last_usage_breakdown = {                               |   |
    |    |        'generation': Usage(input=500, output=200, ...),         |   |
    |    |        'reflection': [Usage(...), ...],                         |   |
    |    |        'review': [Usage(...), ...],                             |   |
    |    |        'total': Usage(input=1200, output=450, ...)              |   |
    |    |    }                                                            |   |
    |    |                                                                  |   |
    |    +------------------------------------------------------------------+   |
    |                                                                           |
    +===========================================================================+


================================================================================
                          WORKFLOW EXAMPLES
================================================================================


    EXAMPLE 1: SIMPLE QC REQUEST
    ============================

    Input: "quality control with nUMI>500, mito<0.2"

         +----------------+
         |  User Request  |
         +-------+--------+
                 |
                 v
         +-------+--------+
         |  Complexity:   |
         |    SIMPLE      |
         +-------+--------+
                 |
                 v
         +-------+--------+
         |  Priority 1    |
         | Registry Only  |
         +-------+--------+
                 |
                 v
    +------------+-----------+
    |  Code Generated:       |
    |  ov.pp.qc(adata,       |
    |    tresh={             |
    |      'nUMIs': 500,     |
    |      'mito_perc': 0.2, |
    |      'detected_genes': |
    |         250            |
    |    })                  |
    +------------+-----------+
                 |
                 v
         +-------+--------+
         |  Reflection    |
         |  (1 iteration) |
         +-------+--------+
                 |
                 v
         +-------+--------+
         |   Execute      |
         +-------+--------+
                 |
                 v
    +------------+-----------+
    |  Output:               |
    |  2.2K cells remaining  |
    |  (500 cells removed)   |
    +------------------------+


    EXAMPLE 2: COMPLEX PIPELINE REQUEST
    ===================================

    Input: "complete QC, normalization, HVG selection, PCA, and clustering"

         +--------------------+
         |   User Request     |
         +---------+----------+
                   |
                   v
         +---------+----------+
         |   Complexity:      |
         |     COMPLEX        |
         +---------+----------+
                   |
                   v
         +---------+----------+
         |   Priority 2       |
         |  Skills + Registry |
         +---------+----------+
                   |
                   v
    +--------------+-------------+
    |  Skill Matched:            |
    |  "single-clustering"       |
    +-------------+--------------+
                  |
                  v
    +-------------+--------------+
    |  Code Generated:           |
    |  (20-50 lines)             |
    |                            |
    |  # QC                      |
    |  ov.pp.qc(adata, ...)      |
    |                            |
    |  # Normalize               |
    |  ov.pp.normalize(adata)    |
    |  ov.pp.log1p(adata)        |
    |                            |
    |  # HVGs                    |
    |  ov.pp.highly_variable_    |
    |    genes(adata, ...)       |
    |                            |
    |  # PCA                     |
    |  ov.pp.pca(adata)          |
    |                            |
    |  # Neighbors               |
    |  ov.pp.neighbors(adata)    |
    |                            |
    |  # Clustering              |
    |  ov.tl.leiden(adata)       |
    |                            |
    |  # UMAP                    |
    |  ov.tl.umap(adata)         |
    +-------------+--------------+
                  |
                  v
         +--------+---------+
         |  Reflection      |
         | (1-3 iterations) |
         +--------+---------+
                  |
                  v
         +--------+---------+
         | Notebook Session |
         |    Execution     |
         +--------+---------+
                  |
                  v
         +--------+---------+
         |  Result Review   |
         | (intent match)   |
         +--------+---------+
                  |
                  v
    +-------------+--------------+
    |  Output:                   |
    |  Clustered adata with:     |
    |  - leiden clusters in .obs |
    |  - X_pca in .obsm          |
    |  - X_umap in .obsm         |
    +----------------------------+


================================================================================
                           FILE STRUCTURE
================================================================================


    /home/user/omicverse/
    |
    +-- omicverse/
    |   |
    |   +-- agent/
    |   |   +-- __init__.py                    # Public API (seeker)
    |   |
    |   +-- utils/
    |   |   +-- smart_agent.py                 # Main agent (3500+ lines)
    |   |   +-- agent_backend.py               # LLM backend
    |   |   +-- model_config.py                # Model registry & config
    |   |   +-- registry.py                    # Function registry
    |   |   +-- skill_registry.py              # Skill loading & routing
    |   |   +-- filesystem_context.py          # Disk-based context
    |   |   +-- session_notebook_executor.py   # Notebook execution
    |   |   |
    |   |   +-- inspector/
    |   |   |   +-- agent_context_injector.py  # Context injection
    |   |   |   +-- inspector.py               # Data state analysis
    |   |   |   +-- prerequisite_checker.py    # Dependency checking
    |   |   |   +-- ...12 more modules
    |   |   |
    |   |   +-- verifier/                      # Skill verification
    |   |
    |   +-- llm/
    |       +-- base.py                        # LLM base classes
    |       +-- CellPLM/                       # Cell foundation model
    |
    +-- .claude/skills/                        # 25 built-in skills
    |   +-- bulk-deg-analysis/
    |   +-- single-clustering/
    |   +-- data-export-pdf/
    |   +-- ...22 more skills
    |
    +-- OvIntelligence/                        # Web UI & RAG system
    |   +-- app.py                             # Streamlit interface
    |   +-- rag_system.py                      # RAG + Gemini integration
    |
    +-- tests/
        +-- utils/
            +-- test_smart_agent.py
            +-- test_agent_initialization.py
            +-- test_agent_backend_*.py


================================================================================
                         COMPLETE FLOW DIAGRAM
================================================================================


    +=========================================================================+
    |                                                                         |
    |                    USER REQUEST + ANNDATA OBJECT                        |
    |                               |                                         |
    +===============================|=========================================+
                                    |
                                    v
                    +---------------+---------------+
                    |                               |
                    |     OMICVERSE AGENT           |
                    |                               |
                    +---------------+---------------+
                                    |
                    +---------------+---------------+
                    |                               |
                    |   DIRECT PYTHON DETECTION     |
                    |                               |
                    +-------+-----------+-----------+
                            |           |
                          YES          NO
                            |           |
                            v           v
                    +-------+    +------+-------+
                    |Execute|    |  COMPLEXITY  |
                    |Direct |    |   ANALYSIS   |
                    +---+---+    +------+-------+
                        |              |
                        |       +------+------+
                        |       |             |
                        |    SIMPLE       COMPLEX
                        |       |             |
                        |       v             v
                        |  +----+----+   +----+----+
                        |  |PRIORITY |   |PRIORITY |
                        |  |   1     |   |   2     |
                        |  +----+----+   +----+----+
                        |       |             |
                        |       v             v
                        |  +----+----+   +----+----+
                        |  |REGISTRY |   | SKILL   |
                        |  | ONLY    |   |MATCHING |
                        |  +----+----+   +----+----+
                        |       |             |
                        |       |    +--------+--------+
                        |       |    |                 |
                        |       |    v                 v
                        |       | +--+---+        +----+----+
                        |       | |SKILL |        |REGISTRY |
                        |       | |LOAD  |        |  INFO   |
                        |       | +--+---+        +----+----+
                        |       |    |                 |
                        |       |    +--------+--------+
                        |       |             |
                        |       +------+------+
                        |              |
                        |              v
                        |     +--------+--------+
                        |     |                 |
                        |     |   LLM BACKEND   |
                        |     |                 |
                        |     +--------+--------+
                        |              |
                        |              v
                        |     +--------+--------+
                        |     |                 |
                        |     | CODE GENERATION |
                        |     |                 |
                        |     +--------+--------+
                        |              |
                        |              v
                        |     +--------+--------+
                        |     |                 |
                        |     |  TRANSFORMATION |
                        |     |                 |
                        |     +--------+--------+
                        |              |
                        |              v
                        |     +--------+--------+
                        |     |                 |
                        |     |   REFLECTION    |<--+
                        |     |   (optional)    |   |
                        |     +--------+--------+   |
                        |              |            |
                        |        +-----+-----+      |
                        |        |           |      |
                        |       OK        REVISE----+
                        |        |
                        +--------+
                                 |
                                 v
                        +--------+--------+
                        |                 |
                        |    EXECUTION    |
                        |   (Notebook/    |
                        |   In-Process)   |
                        +--------+--------+
                                 |
                                 v
                        +--------+--------+
                        |                 |
                        |  RESULT REVIEW  |
                        |   (optional)    |
                        +--------+--------+
                                 |
                                 v
                        +--------+--------+
                        |                 |
                        | MODIFIED ADATA  |
                        |    + USAGE      |
                        |                 |
                        +-----------------+


================================================================================
                              END OF DIAGRAM
================================================================================
